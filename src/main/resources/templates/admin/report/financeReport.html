<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ParQHub - Financial Report</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #0a0f1c; }
        .glass {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
        .active {
            background: linear-gradient(90deg, #ffb703, #ff6600);
            color: #0a0f1c !important;
            font-weight: bold;
        }
    </style>
</head>
<body class="text-white flex">

<!-- Sidebar -->
<aside class="w-72 h-screen glass flex flex-col fixed">
    <div class="p-6 flex items-center gap-3 border-b border-gray-700">
        <img src="/images/logo.svg" alt="ParQHub" class="h-10">
        <span class="text-2xl font-bold">ParQHub</span>
    </div>
    <nav class="flex-1 p-4 space-y-2">
        <a href="/admin/dashboard" class="flex items-center gap-3 p-3 rounded-lg hover:bg-yellow-400/30 transition"><i class="fas fa-home"></i> Dashboard</a>
        <a href="/admin/tables" class="flex items-center gap-3 p-3 rounded-lg hover:bg-yellow-400/30 transition"><i class="fas fa-table"></i> Table View</a>
        <a href="/admin/parking-viewer" class="flex items-center gap-3 p-3 rounded-lg hover:bg-yellow-400/30 transition"><i class="fas fa-parking"></i> Parking Viewer</a>
        <a href="/admin/reports" class="flex items-center gap-3 p-3 rounded-lg hover:bg-yellow-400/30 transition"><i class="fas fa-chart-bar"></i> Report View</a>
    </nav>
    <div class="p-4 border-t border-gray-700">
        <a th:href="@{/admin/logout}" class="flex items-center gap-3 p-3 rounded-lg hover:bg-red-500/30 text-red-400"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </div>
</aside>

<!-- Main Content -->
<main class="ml-72 w-full p-6">
    <!-- Top bar -->
    <div class="flex justify-between items-center mb-6">
        <div class="flex items-center gap-4">
            <a href="/admin/reports" class="text-yellow-400 hover:text-yellow-300 transition">
                <i class="fas fa-arrow-left text-xl"></i>
            </a>
            <h1 class="text-2xl font-bold">Financial Report</h1>
        </div>
        <div class="flex items-center gap-4">
            <button onclick="exportReportCSV()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-400 transition font-semibold">
                <i class="fas fa-download mr-2"></i>Export CSV
            </button>
            <button onclick="exportReport()" class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-400 transition font-semibold">
                <i class="fas fa-file-export mr-2"></i>Export JSON
            </button>
            <button onclick="refreshReport()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-400 transition font-semibold">
                <i class="fas fa-sync-alt mr-2"></i>Refresh
            </button>
            <span class="text-gray-300">Welcome, <span th:text="${adminName}">Admin</span></span>
        </div>
    </div>

    <!-- Report Period Selection -->
    <div class="glass p-6 rounded-lg mb-6">
        <h2 class="text-xl font-bold mb-4">Report Filters</h2>
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
            <div>
                <label for="startDate" class="block text-sm font-medium text-gray-300 mb-2">Start Date</label>
                <input type="date" id="startDate" class="bg-gray-700/50 border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:border-yellow-400 w-full">
            </div>
            <div>
                <label for="endDate" class="block text-sm font-medium text-gray-300 mb-2">End Date</label>
                <input type="date" id="endDate" class="bg-gray-700/50 border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:border-yellow-400 w-full">
            </div>
            <div>
                <label for="cityFilter" class="block text-sm font-medium text-gray-300 mb-2">City</label>
                <select id="cityFilter" class="bg-gray-700/50 border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:border-yellow-400 w-full">
                    <option value="">All Cities</option>
                </select>
            </div>
            <div>
                <label for="locationFilter" class="block text-sm font-medium text-gray-300 mb-2">Location</label>
                <select id="locationFilter" class="bg-gray-700/50 border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:border-yellow-400 w-full" disabled>
                    <option value="">All Locations</option>
                </select>
            </div>
            <button onclick="generateReport()" class="bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-400 transition font-semibold">
                <i class="fas fa-chart-bar mr-2"></i>Generate Report
            </button>
        </div>
    </div>

    <!-- Financial Summary -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
        <div class="glass p-6 rounded-lg text-center">
            <div class="text-3xl font-bold text-green-400 mb-2" id="totalRevenue">LKR 0.00</div>
            <div class="text-sm text-gray-400">Total Revenue</div>
        </div>
        <div class="glass p-6 rounded-lg text-center">
            <div class="text-3xl font-bold text-blue-400 mb-2" id="totalPayments">0</div>
            <div class="text-sm text-gray-400">Total Payments</div>
        </div>
        <div class="glass p-6 rounded-lg text-center">
            <div class="text-3xl font-bold text-purple-400 mb-2" id="avgPayment">LKR 0.00</div>
            <div class="text-sm text-gray-400">Avg Payment</div>
        </div>
        <div class="glass p-6 rounded-lg text-center">
            <div class="text-3xl font-bold text-yellow-400 mb-2" id="pendingAmount">LKR 0.00</div>
            <div class="text-sm text-gray-400">Pending Amount</div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Revenue Chart -->
        <div class="glass p-6 rounded-lg">
            <h3 class="text-lg font-bold mb-4">Revenue Trend</h3>
            <canvas id="revenueChart" width="400" height="200"></canvas>
        </div>

        <!-- Payment Methods Chart -->
        <div class="glass p-6 rounded-lg">
            <h3 class="text-lg font-bold mb-4">Payment Methods</h3>
            <canvas id="paymentMethodsChart" width="400" height="200"></canvas>
        </div>
    </div>

    <!-- Location Revenue Breakdown -->
    <div class="glass p-6 rounded-lg mb-6">
        <h3 class="text-lg font-bold mb-4">Revenue by Location</h3>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr class="border-b border-gray-600">
                        <th class="text-left py-3 px-4">City</th>
                        <th class="text-left py-3 px-4">Location</th>
                        <th class="text-left py-3 px-4">Revenue (LKR)</th>
                        <th class="text-left py-3 px-4">Percentage</th>
                    </tr>
                </thead>
                <tbody id="locationBreakdownTable">
                    <!-- Location breakdown will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Payment Status Chart -->
    <div class="glass p-6 rounded-lg mb-6">
        <h3 class="text-lg font-bold mb-4">Payment Status Distribution</h3>
        <canvas id="paymentStatusChart" width="800" height="300"></canvas>
    </div>

    <!-- Recent Transactions -->
    <div class="glass p-6 rounded-lg">
        <h3 class="text-lg font-bold mb-4">Recent Transactions</h3>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr class="border-b border-gray-600">
                        <th class="text-left py-3 px-4">Transaction ID</th>
                        <th class="text-left py-3 px-4">User</th>
                        <th class="text-left py-3 px-4">Amount (LKR)</th>
                        <th class="text-left py-3 px-4">Method</th>
                        <th class="text-left py-3 px-4">Status</th>
                        <th class="text-left py-3 px-4">Location</th>
                        <th class="text-left py-3 px-4">Date</th>
                    </tr>
                </thead>
                <tbody id="transactionsTable">
                    <!-- Transactions will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
</main>

<script>
// Initialize charts
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    loadInitialSummary();
    setDefaultDates();
    setupLocationFiltering();
});

function setDefaultDates() {
    const today = new Date();
    const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
    
    document.getElementById('startDate').value = lastMonth.toISOString().split('T')[0];
    document.getElementById('endDate').value = today.toISOString().split('T')[0];
}

function initializeCharts() {
    // Revenue Chart
    const revenueCtx = document.getElementById('revenueChart').getContext('2d');
    window.revenueChart = new Chart(revenueCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Revenue ($)',
                data: [],
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    labels: { color: '#ffffff' }
                }
            },
            scales: {
                x: { ticks: { color: '#ffffff' } },
                y: { ticks: { color: '#ffffff' } }
            }
        }
    });

    // Payment Methods Chart
    const paymentMethodsCtx = document.getElementById('paymentMethodsChart').getContext('2d');
    window.paymentMethodsChart = new Chart(paymentMethodsCtx, {
        type: 'doughnut',
        data: {
            labels: [],
            datasets: [{
                data: [],
                backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444']
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    labels: { color: '#ffffff' }
                }
            }
        }
    });

    // Payment Status Chart
    const paymentStatusCtx = document.getElementById('paymentStatusChart').getContext('2d');
    window.paymentStatusChart = new Chart(paymentStatusCtx, {
        type: 'bar',
        data: {
            labels: ['Completed', 'Pending', 'Failed', 'Refunded'],
            datasets: [{
                label: 'Count',
                data: [0, 0, 0, 0],
                backgroundColor: ['#10b981', '#f59e0b', '#ef4444', '#6b7280']
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    labels: { color: '#ffffff' }
                }
            },
            scales: {
                x: { ticks: { color: '#ffffff' } },
                y: { ticks: { color: '#ffffff' } }
            }
        }
    });
}

function loadRecentTransactions() {
    // This will be populated by generateReport() function
    // Default empty state
    const tbody = document.getElementById('transactionsTable');
    tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-400">No transactions to display. Please generate a report.</td></tr>';
}

function loadInitialSummary() {
    fetch('/admin/api/reports/financial/initial')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Error loading initial summary:', data.error);
                return;
            }
            updateFinancialSummary(data);
            updateLocationBreakdown(data.locationBreakdown, data.totalRevenue);
            populateFilterOptions(data.cities, data.cityLocations);
        })
        .catch(error => {
            console.error('Error loading initial summary:', error);
        });
}

function populateFilterOptions(cities, cityLocations) {
    const citySelect = document.getElementById('cityFilter');
    const locationSelect = document.getElementById('locationFilter');
    
    // Clear existing options (except "All Cities")
    citySelect.innerHTML = '<option value="">All Cities</option>';
    
    // Populate cities
    cities.forEach(city => {
        const option = document.createElement('option');
        option.value = city;
        option.textContent = city.charAt(0).toUpperCase() + city.slice(1);
        citySelect.appendChild(option);
    });
    
    // Store city-location mapping
    window.cityLocations = cityLocations;
}

function setupLocationFiltering() {
    const citySelect = document.getElementById('cityFilter');
    const locationSelect = document.getElementById('locationFilter');
    
    citySelect.addEventListener('change', function() {
        const selectedCity = this.value;
        
        // Clear location options
        locationSelect.innerHTML = '<option value="">All Locations</option>';
        
        if (selectedCity && window.cityLocations && window.cityLocations[selectedCity]) {
            locationSelect.disabled = false;
            window.cityLocations[selectedCity].forEach(location => {
                const option = document.createElement('option');
                option.value = location;
                option.textContent = location.charAt(0).toUpperCase() + location.slice(1);
                locationSelect.appendChild(option);
            });
        } else {
            locationSelect.disabled = true;
        }
    });
}

function updateFinancialSummary(data) {
    // Update summary cards with LKR currency
    document.getElementById('totalRevenue').textContent = `LKR ${data.totalRevenue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
    document.getElementById('totalPayments').textContent = data.totalPayments.toLocaleString();
    document.getElementById('avgPayment').textContent = `LKR ${data.avgPayment.toFixed(2)}`;
    document.getElementById('pendingAmount').textContent = `LKR ${data.pendingAmount.toFixed(2)}`;
}

function updateLocationBreakdown(locationBreakdown, totalRevenue) {
    const tbody = document.getElementById('locationBreakdownTable');
    tbody.innerHTML = '';

    if (!locationBreakdown || locationBreakdown.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-400">No location data available.</td></tr>';
        return;
    }

    locationBreakdown.forEach(location => {
        const row = document.createElement('tr');
        row.className = 'border-b border-gray-700 hover:bg-gray-700/30';
        
        const percentage = totalRevenue > 0 ? (location.revenue / totalRevenue * 100).toFixed(1) : 0;
        
        row.innerHTML = `
            <td class="py-3 px-4 capitalize">${location.city}</td>
            <td class="py-3 px-4 capitalize">${location.location}</td>
            <td class="py-3 px-4">LKR ${location.revenue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
            <td class="py-3 px-4">${percentage}%</td>
        `;
        tbody.appendChild(row);
    });
}

function showSuccessMessage(message) {
    // Create a temporary success message
    const successDiv = document.createElement('div');
    successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
    successDiv.innerHTML = `<i class="fas fa-check mr-2"></i>${message}`;
    document.body.appendChild(successDiv);
    
    // Remove after 3 seconds
    setTimeout(() => {
        document.body.removeChild(successDiv);
    }, 3000);
}

function updateTransactionsTable(transactions) {
    const tbody = document.getElementById('transactionsTable');
    tbody.innerHTML = '';

    if (!transactions || transactions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-400">No transactions found for the selected period.</td></tr>';
        return;
    }

    transactions.forEach(txn => {
        const row = document.createElement('tr');
        row.className = 'border-b border-gray-700 hover:bg-gray-700/30';
        
        const statusColor = txn.status === 'Completed' ? 'text-green-400' : 
                          txn.status === 'Pending' ? 'text-yellow-400' : 
                          txn.status === 'Failed' ? 'text-red-400' : 'text-gray-400';
        
        row.innerHTML = `
            <td class="py-3 px-4">${txn.id}</td>
            <td class="py-3 px-4">${txn.user}</td>
            <td class="py-3 px-4">${txn.amount}</td>
            <td class="py-3 px-4">${txn.method}</td>
            <td class="py-3 px-4 ${statusColor}">${txn.status}</td>
            <td class="py-3 px-4 text-xs">${txn.location || 'N/A'}</td>
            <td class="py-3 px-4">${txn.date}</td>
        `;
        tbody.appendChild(row);
    });
}

function updateCharts(data) {
    // Update revenue chart with actual data
    if (data.revenueData && data.revenueData.length > 0) {
        const labels = data.revenueData.map(item => item.date);
        const values = data.revenueData.map(item => item.revenue);
        
        // Update the existing chart with new data
        if (window.revenueChart) {
            window.revenueChart.data.labels = labels;
            window.revenueChart.data.datasets[0].data = values;
            window.revenueChart.update();
        }
    }
    
    // Update payment methods chart
    if (data.paymentMethods) {
        const methods = Object.keys(data.paymentMethods);
        const counts = Object.values(data.paymentMethods);
        
        if (window.paymentMethodsChart) {
            window.paymentMethodsChart.data.labels = methods;
            window.paymentMethodsChart.data.datasets[0].data = counts;
            window.paymentMethodsChart.update();
        }
    }
    
    // Update payment status chart
    if (window.paymentStatusChart) {
        window.paymentStatusChart.data.datasets[0].data = [
            data.completedPayments,
            data.pendingPayments,
            data.failedPayments,
            0 // Refunded - not implemented yet
        ];
        window.paymentStatusChart.update();
    }
}

function generateReport() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const city = document.getElementById('cityFilter').value;
    const location = document.getElementById('locationFilter').value;
    
    if (!startDate || !endDate) {
        alert('Please select both start and end dates');
        return;
    }
    
    if (new Date(startDate) > new Date(endDate)) {
        alert('Start date cannot be after end date');
        return;
    }
    
    // Show loading state
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Generating...';
    button.disabled = true;
    
    // Build query parameters
    let params = `startDate=${startDate}&endDate=${endDate}`;
    if (city) params += `&city=${encodeURIComponent(city)}`;
    if (location) params += `&location=${encodeURIComponent(location)}`;
    
    // Fetch financial report data from backend
    fetch(`/admin/api/reports/financial?${params}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            updateFinancialSummary(data);
            updateCharts(data);
            updateTransactionsTable(data.recentTransactions);
            updateLocationBreakdown(data.locationBreakdown, data.totalRevenue);
            
            // Show success message
            showSuccessMessage(`Report generated successfully! Report ID: ${data.reportId}`);
        })
        .catch(error => {
            console.error('Error generating report:', error);
            alert('Failed to generate report: ' + error.message);
        })
        .finally(() => {
            // Reset button state
            button.innerHTML = originalText;
            button.disabled = false;
        });
}

function exportReport() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const city = document.getElementById('cityFilter').value;
    const location = document.getElementById('locationFilter').value;
    
    if (!startDate || !endDate) {
        alert('Please select date range and generate a report first');
        return;
    }
    
    // Show loading state
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Exporting...';
    button.disabled = true;
    
    // Build query parameters
    let params = `startDate=${startDate}&endDate=${endDate}&format=json`;
    if (city) params += `&city=${encodeURIComponent(city)}`;
    if (location) params += `&location=${encodeURIComponent(location)}`;
    
    // Fetch export data
    fetch(`/admin/api/reports/financial/export?${params}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            
            // Create and download JSON file
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            
            // Create filename with filters
            let filename = `financial-report-${startDate}-to-${endDate}`;
            if (city) filename += `-${city}`;
            if (location) filename += `-${location}`;
            filename += '.json';
            
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Clean up the URL
            URL.revokeObjectURL(link.href);
        })
        .catch(error => {
            console.error('Error exporting report:', error);
            alert('Failed to export report: ' + error.message);
        })
        .finally(() => {
            // Reset button state
            button.innerHTML = originalText;
            button.disabled = false;
        });
}

function refreshReport() {
    // Call generateReport with current date values
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    if (startDate && endDate) {
        generateReport();
    } else {
        alert('Please select date range first');
    }
}

function exportReportCSV() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const city = document.getElementById('cityFilter').value;
    const location = document.getElementById('locationFilter').value;
    
    if (!startDate || !endDate) {
        alert('Please select date range and generate a report first');
        return;
    }
    
    // Show loading state
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Exporting...';
    button.disabled = true;
    
    // Build query parameters
    let params = `startDate=${startDate}&endDate=${endDate}`;
    if (city) params += `&city=${encodeURIComponent(city)}`;
    if (location) params += `&location=${encodeURIComponent(location)}`;
    
    // Create download link
    const link = document.createElement('a');
    link.href = `/admin/api/reports/financial/export-csv?${params}`;
    
    // Create filename with filters
    let filename = `financial-report-${startDate}-to-${endDate}`;
    if (city) filename += `-${city}`;
    if (location) filename += `-${location}`;
    filename += '.csv';
    
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Reset button state
    setTimeout(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    }, 1000);
}
</script>

</body>
</html>
