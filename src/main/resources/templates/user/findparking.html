<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ParQHub - Find Parking</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Icons -->
    <script src="https://kit.fontawesome.com/4ad8d5ae3f.js" crossorigin="anonymous"></script>

    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #0a0f1c; }
        .glass {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
        .active {
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
            color: #ffffff !important;
            font-weight: bold;
        }
        .parking-grid {
            display: grid;
            grid-template-columns: repeat(50, 1fr);
            gap: 2px;
            max-width: 100%;
            overflow-x: auto;
        }
        .parking-spot {
            width: 20px;
            height: 20px;
            border: 1px solid #374151;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .parking-spot:hover {
            transform: scale(1.1);
            z-index: 10;
        }
        .spot-available {
            background-color: #10b981;
            border-color: #059669;
        }
        .spot-occupied {
            background-color: #ef4444;
            border-color: #dc2626;
        }
        .spot-selected {
            background-color: #3b82f6;
            border-color: #1d4ed8;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }
        .spot-disabled {
            background-color: #6b7280;
            border-color: #4b5563;
            cursor: not-allowed;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            border: 1px solid #374151;
        }
        .location-card {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .location-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        .location-card.selected {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }
    </style>
</head>
<body class="text-white flex">

<!-- Sidebar -->
<aside class="w-72 h-screen glass flex flex-col fixed">
    <div class="p-6 flex items-center gap-3 border-b border-gray-700">
        <img src="/images/logo.png" alt="ParQHub" class="h-10">
        <span class="text-2xl font-bold">ParQHub</span>
    </div>
    <nav class="flex-1 p-4 space-y-2">
        <!-- User Navigation Links -->
        <a href="/user/dashboard" class="flex items-center gap-3 p-3 rounded-lg hover:bg-blue-400/30 transition">
            <i class="fas fa-home"></i> Dashboard
        </a>
        <a href="/user/findparking" class="flex items-center gap-3 p-3 rounded-lg hover:bg-blue-400/30 transition active">
            <i class="fas fa-parking"></i> Find Parking
        </a>
        <a href="/user/bookings" class="flex items-center gap-3 p-3 rounded-lg hover:bg-blue-400/30 transition">
            <i class="fas fa-calendar-check"></i> My Bookings
        </a>
        <a href="/user/vehicles" class="flex items-center gap-3 p-3 rounded-lg hover:bg-blue-400/30 transition">
            <i class="fas fa-car"></i> My Vehicles
        </a>
        <a href="/user/payments" class="flex items-center gap-3 p-3 rounded-lg hover:bg-blue-400/30 transition">
            <i class="fas fa-credit-card"></i> Payment History
        </a>
        <a href="/user/notifications" class="flex items-center gap-3 p-3 rounded-lg hover:bg-blue-400/30 transition">
            <i class="fas fa-bell"></i> Notifications
        </a>
        <a href="/user/settings" class="flex items-center gap-3 p-3 rounded-lg hover:bg-blue-400/30 transition">
            <i class="fas fa-cog"></i> Settings
        </a>
    </nav>
    <div class="p-4 border-t border-gray-700">
        <a th:href="@{/user/logout}" class="flex items-center gap-3 p-3 rounded-lg hover:bg-red-500/30 text-red-400">
            <i class="fas fa-sign-out-alt"></i> Logout
        </a>
    </div>
</aside>

<!-- Main Content -->
<main class="ml-72 w-full p-6">
    <!-- Top bar -->
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold">Find Parking Spot</h1>
        <div class="flex items-center gap-4">
            <span class="text-gray-300">Welcome, <span th:text="${userName}">User</span></span>
            <img src="/images/user-avatar.png" alt="User" class="h-10 w-10 rounded-full border-2 border-blue-400">
        </div>
    </div>

    <!-- Location Selection -->
    <div class="glass p-6 rounded-2xl mb-6">
        <h2 class="text-xl font-bold mb-4 text-blue-400">Select Location</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div th:each="lot : ${parkingLots}" 
                 th:data-lot-id="${lot.id}"
                 class="location-card flex items-center gap-3 p-3 bg-gray-700/30 rounded-lg cursor-pointer hover:bg-gray-600/30 transition"
                 th:onclick="'selectLocation(' + ${lot.id} + ', \'' + ${lot.location} + '\')'">
                <i class="fas fa-building text-blue-400"></i>
                <div>
                    <h3 class="font-semibold" th:text="${lot.location}">Location</h3>
                    <p class="text-sm text-gray-400">
                        Available: <span th:text="${lot.totalSlots}">0</span> spots
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Parking Grid Section -->
    <div id="parkingGridSection" class="glass p-6 rounded-2xl mb-6" style="display: none;">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-blue-400" id="gridTitle">Parking Grid</h2>
            <div class="flex gap-4">
                <button id="zoomIn" class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-sm">
                    <i class="fas fa-search-plus"></i> Zoom In
                </button>
                <button id="zoomOut" class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-sm">
                    <i class="fas fa-search-minus"></i> Zoom Out
                </button>
            </div>
        </div>

        <!-- Legend -->
        <div class="flex gap-6 mb-4 text-sm">
            <div class="legend-item">
                <div class="legend-color spot-available"></div>
                <span>Available</span>
            </div>
            <div class="legend-item">
                <div class="legend-color spot-occupied"></div>
                <span>Occupied</span>
            </div>
            <div class="legend-item">
                <div class="legend-color spot-selected"></div>
                <span>Selected</span>
            </div>
            <div class="legend-item">
                <div class="legend-color spot-disabled"></div>
                <span>Disabled</span>
            </div>
        </div>

        <!-- Parking Grid Container -->
        <div class="border border-gray-600 rounded-lg p-4 bg-gray-800/30 overflow-auto">
            <div id="parkingGrid" class="parking-grid mx-auto" style="width: fit-content;">
                <!-- Grid will be generated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Booking Details -->
    <div class="glass p-6 rounded-2xl">
        <h2 class="text-xl font-bold mb-4 text-green-400">Booking Details</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label class="block text-sm font-medium mb-2">Selected Spot</label>
                <input type="text" id="selectedSpot" readonly class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">Duration</label>
                <select id="duration" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                    <option value="1">1 Hour</option>
                    <option value="2">2 Hours</option>
                    <option value="3">3 Hours</option>
                    <option value="4">4 Hours</option>
                    <option value="5">5 Hours</option>
                    <option value="6">6 Hours</option>
                    <option value="8">8 Hours</option>
                    <option value="12">12 Hours</option>
                    <option value="24">24 Hours</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">Start Time</label>
                <input type="datetime-local" id="startTime" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">Vehicle</label>
                <select id="vehicle" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                    <option value="">Select Vehicle</option>
                    <option th:each="vehicle : ${userVehicles}" 
                            th:value="${vehicle.id}" 
                            th:text="${vehicle.brand + ' ' + vehicle.model + ' - ' + vehicle.vehicleNo}">
                        Vehicle
                    </option>
                </select>
            </div>
        </div>
        
        <div class="mt-6">
            <button id="bookSpot" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold transition disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fas fa-check mr-2"></i> Book Parking Spot
            </button>
        </div>
    </div>
</main>

<script th:inline="javascript">
    let selectedLocationId = null;
    let selectedLocationName = null;
    let parkingSlots = [];

    // Select location
    function selectLocation(lotId, locationName) {
        // Remove previous selection
        document.querySelectorAll('.location-card').forEach(card => {
            card.classList.remove('selected');
        });
        
        // Select new location
        event.currentTarget.classList.add('selected');
        selectedLocationId = lotId;
        selectedLocationName = locationName;
        
        // Update grid title
        document.getElementById('gridTitle').textContent = `Parking Grid - ${locationName}`;
        
        // Show parking grid section
        document.getElementById('parkingGridSection').style.display = 'block';
        
        // Load parking slots for this location
        loadParkingSlots(lotId);
    }

    // Load parking slots from backend
    async function loadParkingSlots(lotId) {
        try {
            const response = await fetch(`/user/parking-slots/${lotId}`);
            parkingSlots = await response.json();
            generateParkingGrid();
        } catch (error) {
            console.error('Error loading parking slots:', error);
            // Generate demo grid if API fails
            generateDemoGrid();
        }
    }

    // Generate parking grid from actual data
    function generateParkingGrid() {
        const grid = document.getElementById('parkingGrid');
        grid.innerHTML = '';
        
        if (parkingSlots.length === 0) {
            generateDemoGrid();
            return;
        }

        // Create a 50x25 grid based on available slots
        const rows = 25;
        const cols = 50;
        
        for (let row = 0; row < rows; row++) {
            for (let col = 0; col < cols; col++) {
                const spot = document.createElement('div');
                const spotId = `${String.fromCharCode(65 + Math.floor(row / 10))}-${String(col + 1).padStart(2, '0')}`;
                
                // Find corresponding slot in parkingSlots array
                const slotIndex = (row * cols + col) % parkingSlots.length;
                const slot = parkingSlots[slotIndex];
                
                let spotClass = 'spot-available';
                let spotText = spotId;
                
                if (slot) {
                    switch(slot.status) {
                        case 'Booked':
                            spotClass = 'spot-occupied';
                            spotText = 'B';
                            break;
                        case 'Occupied':
                            spotClass = 'spot-occupied';
                            spotText = 'O';
                            break;
                        default:
                            spotClass = 'spot-available';
                            spotText = spotId;
                    }
                }
                
                spot.className = `parking-spot ${spotClass}`;
                spot.textContent = spotText;
                spot.dataset.spotId = spotId;
                spot.dataset.slotId = slot ? slot.id : null;
                
                // Add click event for available spots
                if (spotClass === 'spot-available') {
                    spot.addEventListener('click', () => selectSpot(spot, spotId, slot ? slot.id : null));
                }
                
                grid.appendChild(spot);
            }
        }
    }

    // Generate demo grid (fallback)
    function generateDemoGrid() {
        const grid = document.getElementById('parkingGrid');
        const rows = 25;
        const cols = 50;
        
        for (let row = 0; row < rows; row++) {
            for (let col = 0; col < cols; col++) {
                const spot = document.createElement('div');
                const spotId = `${String.fromCharCode(65 + Math.floor(row / 10))}-${String(col + 1).padStart(2, '0')}`;
                
                // Randomly assign spot status (for demo purposes)
                const random = Math.random();
                let spotClass = 'spot-available';
                let spotText = spotId;
                
                if (random < 0.3) {
                    spotClass = 'spot-occupied';
                    spotText = 'X';
                } else if (random < 0.35) {
                    spotClass = 'spot-disabled';
                    spotText = 'D';
                }
                
                spot.className = `parking-spot ${spotClass}`;
                spot.textContent = spotText;
                spot.dataset.spotId = spotId;
                
                // Add click event for available spots
                if (spotClass === 'spot-available') {
                    spot.addEventListener('click', () => selectSpot(spot, spotId, null));
                }
                
                grid.appendChild(spot);
            }
        }
    }

    // Select parking spot
    function selectSpot(spotElement, spotId, slotId) {
        // Remove previous selection
        document.querySelectorAll('.spot-selected').forEach(spot => {
            spot.classList.remove('spot-selected');
            if (spot.dataset.slotId) {
                spot.classList.add('spot-available');
            }
        });
        
        // Select new spot
        spotElement.classList.remove('spot-available');
        spotElement.classList.add('spot-selected');
        
        // Update booking details
        document.getElementById('selectedSpot').value = spotId;
        document.getElementById('bookSpot').disabled = false;
    }

    // Set default start time to current time
    function setDefaultStartTime() {
        const now = new Date();
        const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
        document.getElementById('startTime').value = localDateTime;
    }

    // Book spot functionality
    document.getElementById('bookSpot').addEventListener('click', async function() {
        const selectedSpot = document.getElementById('selectedSpot').value;
        const duration = document.getElementById('duration').value;
        const startTime = document.getElementById('startTime').value;
        const vehicle = document.getElementById('vehicle').value;
        
        if (!selectedSpot || !duration || !startTime || !vehicle) {
            alert('Please fill in all fields');
            return;
        }

        if (!selectedLocationId) {
            alert('Please select a parking location first');
            return;
        }
        
        try {
            const formData = new FormData();
            formData.append('slotId', selectedLocationId); // Using location ID as slot ID for demo
            formData.append('vehicleId', vehicle);
            formData.append('startTime', startTime);
            formData.append('duration', duration);
            
            const response = await fetch('/user/book-parking', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.text();
            
            if (result.startsWith('success:')) {
                alert(result.replace('success:', ''));
                
                // Reset form
                document.getElementById('selectedSpot').value = '';
                document.getElementById('vehicle').value = '';
                document.getElementById('bookSpot').disabled = true;
                
                // Reset grid selection
                document.querySelectorAll('.spot-selected').forEach(spot => {
                    spot.classList.remove('spot-selected');
                    if (spot.dataset.slotId) {
                        spot.classList.add('spot-available');
                    }
                });
            } else {
                alert(result.replace('error:', ''));
            }
        } catch (error) {
            alert('Error creating booking: ' + error.message);
        }
    });

    // Zoom functionality
    let currentZoom = 1;
    document.getElementById('zoomIn').addEventListener('click', () => {
        if (currentZoom < 3) {
            currentZoom += 0.2;
            document.getElementById('parkingGrid').style.transform = `scale(${currentZoom})`;
        }
    });
    
    document.getElementById('zoomOut').addEventListener('click', () => {
        if (currentZoom > 0.5) {
            currentZoom -= 0.2;
            document.getElementById('parkingGrid').style.transform = `scale(${currentZoom})`;
        }
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        setDefaultStartTime();
        document.getElementById('bookSpot').disabled = true;
    });
</script>
</body>
</html>
